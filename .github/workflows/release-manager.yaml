name: Automated Release Actions
on:
  schedule:
    - cron: "0 0 * * *" # At every day at 00
  workflow_dispatch:
    inputs:
      action:
        description: 'Select Action'
        required: true
        type: choice
        options:
          - new-release
          - new-patch
          - update-upstream-versions
      version:
        description: |
          Provide Release Version for the action. Eg 1.22 or 1.23'
        required: true
        type: string
permissions:
  contents: write
  pull-requests: write
jobs:
  run-release:
    runs-on: ubuntu-latest
    env:
      ACTION: ${{ github.event.inputs.action || 'update-upstream-versions' }}
      VERSION: ${{ github.event.inputs.version || 'next' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Debug inputs
        run: |
          echo "Action: $ACTION"
          echo "Version: $VERSION"

      - name: Run Release Script
        env:
          GH_TOKEN: ${{ secrets.OPENSHIFT_PIPELINES_ROBOT }}
          GITHUB_TOKEN: ${{ secrets.OPENSHIFT_PIPELINES_ROBOT }}
        run: |
          ./hack/release-manager.sh \
            --action "$ACTION" \
            --version "$VERSION" 

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -x
          git config user.name openshift-pipelines-bot
          git config user.email pipelines-extcomm@redhat.com
          
          BASE_BRANCH=${GITHUB_REF#refs/heads/}
          SOURCE_BRANCH=actions/$BASE_BRANCH/$ACTION-$VERSION
          
          git checkout -b ${SOURCE_BRANCH}
          git add -f config .github
          
          if [[ -z $(git status --porcelain --untracked-files=no) ]]; then
            echo "No change, exiting"
            exit 0
          fi
          
          git commit -F- <<EOF
            [bot: $VERSION] Release Action: $ACTION
          EOF
          
          git push -f origin ${SOURCE_BRANCH}  
        
          if [ "$(gh pr list --base ${BASE_BRANCH} --head ${SOURCE_BRANCH} --json url --jq 'length')" = "0" ]; then
            echo "creating PR..."
            gh pr create -B ${BASE_BRANCH} -H ${SOURCE_BRANCH} --label=automated  --fill
          fi
